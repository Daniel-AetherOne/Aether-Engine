<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painting Estimate Request — {{ tenant_id or "painters_us" }}</title>

  <style>
    @import url("https://cdn.jsdelivr.net/npm/geist@1.3.0/dist/fonts/geist-sans/style.css");

    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --muted2:#94a3b8;
      --line:#e5e7eb;

      --primary:#0f172a;
      --primaryHover:#020617;

      --okBorder: rgba(16,185,129,.25);
      --okBg: #ecfdf5;
      --errBorder: rgba(239,68,68,.25);
      --errBg: #fef2f2;

      --shadow: 0 10px 30px rgba(2,6,23,0.06);
      --shadowSm: 0 6px 18px rgba(2,6,23,0.05);

      --radius: 20px;
      --radiusSm: 14px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Geist Sans", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
      padding:28px 16px;
    }

    a{ color: inherit; text-decoration:none; }

    .topbar{
      max-width:1120px;
      margin:0 auto 16px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
    }
    .brandBlock{display:flex;flex-direction:column;gap:6px}
    .brandTitle{font-size:18px;font-weight:800;letter-spacing:-0.015em}
    .brandSub{color:var(--muted);font-size:13px;line-height:1.45;max-width:80ch}

    .badges{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      box-shadow:var(--shadowSm);
    }
    .badge strong{color:var(--text);font-weight:750}

    .wrap{
      max-width:1120px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.45fr .55fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width:980px){
      .topbar{align-items:flex-start;flex-direction:column}
      .badges{justify-content:flex-start}
      .wrap{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .header{
      padding:22px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .title{font-size:22px;font-weight:850;letter-spacing:-0.02em;margin-bottom:6px}
    .subtitle{color:var(--muted);line-height:1.55;font-size:14px;max-width:72ch}
    .content{padding:18px 22px 22px}

    .stepRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
    .step{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .dot{
      width:9px;height:9px;border-radius:999px;
      background:rgba(15,23,42,.45);
      box-shadow:0 0 0 4px rgba(15,23,42,.08);
    }
    .step strong{color:var(--text);font-weight:850}

    .grid{display:grid;gap:14px}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.three{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:740px){
      .grid.two,.grid.three{grid-template-columns:1fr}
    }

    label{
      display:block;
      font-size:12px;
      letter-spacing:.35px;
      color:var(--muted2);
      margin:0 0 8px 2px;
      text-transform:uppercase;
      font-weight:800;
    }

    input,textarea,select{
      width:100%;
      padding:14px 16px;
	  font-size:15px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
      transition:border .15s ease, box-shadow .15s ease;
    }
    input::placeholder,textarea::placeholder{color:rgba(15,23,42,.35)}
    input:focus,textarea:focus,select:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(15,23,42,.08);
    }
    textarea{min-height:110px;resize:vertical}

    .hint{
      font-size:13px;
      color:var(--muted);
      line-height:1.5;
      margin-top:10px;
    }

    .section{
      margin-top:18px;
      padding-top:18px;
      border-top:1px solid var(--line);
    }
    .sectionTitle{
      font-weight:900;
      font-size:13px;
      margin-bottom:10px;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:var(--text);
    }

    /* Upload */
    .uploadBox{
      border:1.5px dashed #cbd5e1;
      border-radius:16px;
      padding:16px;
      background:#ffffff;
      cursor:pointer;
      transition:all .15s ease;
      display:block;
    }
    .uploadBox:hover{
      border-color:var(--primary);
      background:#ffffff;
    }
    .uploadTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .uploadTitle{font-weight:900;font-size:14px;letter-spacing:-0.01em}
    .uploadMeta{color:var(--muted);font-size:12px;line-height:1.4}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
    }

    .files{margin-top:10px;display:grid;gap:8px}
    .fileRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      font-size:13px;
      color:var(--text);
    }
    .fileRow small{color:var(--muted)}
    .status{margin-top:10px;font-size:13px;color:var(--muted)}

    .tag{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
    }
    .tag.up{ color:#0f172a; }
    .tag.ok{ color:#065f46; border-color:rgba(16,185,129,.25); background:rgba(16,185,129,.08); }

    /* Actions */
    .actions{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      appearance:none;
      border:none;
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      transition:transform .05s ease, opacity .15s ease, box-shadow .15s ease, background .15s ease, border .15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{
  background:#0f172a;
  color:#fff;
  box-shadow:none;
}
    .btnPrimary:hover{
  background:#020617;
}}
    .btnGhost{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
    }
    .btnGhost:hover{background:#f8fafc}
    .btn[disabled]{opacity:.55;cursor:not-allowed}

    /* Messages */
    .msg{
      display:none;
      margin-bottom:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:13px;
      line-height:1.5;
    }
    .msg.ok{border-color:var(--okBorder); background:var(--okBg)}
    .msg.err{border-color:var(--errBorder); background:var(--errBg)}
    .tiny{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.4}

    /* Sidebar */
    .sideCard .content{padding:16px}
    .sideTitle{
      font-weight:950;
      font-size:13px;
      margin-bottom:10px;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:var(--text);
    }
    .sideList{display:grid;gap:10px}
    .sideItem{
      padding:14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
    }
    .sideItem b{display:block;margin-bottom:4px;font-weight:950}
    .sideItem span{color:var(--muted);font-size:13px;line-height:1.45}

    .summary{
      margin-top:12px;
      border-top:1px solid var(--line);
      padding-top:12px;
      display:grid;
      gap:8px;
      color:var(--muted);
      font-size:13px
    }
    .kv{display:flex;justify-content:space-between;gap:10px}
    .kv strong{color:var(--text);font-weight:950}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brandBlock">
      <div class="brandTitle">Painting Estimate Request</div>
      <div class="brandSub">Fast, itemized estimate based on area + photos. Typical turnaround: minutes.</div>
    </div>
    <div class="badges">
      <div class="badge">Tenant: <strong>{{ tenant_id or "painters_us" }}</strong></div>
      <div class="badge">Units: <strong>Square Feet</strong></div>
      <div class="badge">Photos: <strong>1–5</strong></div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="title">Tell us about the project</div>
        <div class="subtitle">
          Fill in your contact details, approximate paintable area, and upload a few photos.
          We’ll generate a clean estimate for labor &amp; materials.
        </div>
        <div class="stepRow">
          <div class="step"><span class="dot"></span> <span><strong>1</strong> Contact</span></div>
          <div class="step"><span class="dot"></span> <span><strong>2</strong> Area &amp; scope</span></div>
          <div class="step"><span class="dot"></span> <span><strong>3</strong> Photos</span></div>
        </div>
      </div>

      <div class="content">
        <div id="msgOk" class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>

        <form id="intakeForm" enctype="multipart/form-data">
          <input type="hidden" name="tenant_id" value="{{ tenant_id or 'painters_us' }}" />
          <input type="hidden" name="vertical" value="{{ vertical or 'painters_us' }}" />
          <input type="hidden" name="area_unit" value="sqft" />
          <input type="hidden" name="lead_id" id="lead_id" value="" />

          <div class="section" style="margin-top:0;padding-top:0;border-top:none;">
            <div class="sectionTitle">Contact</div>
            <div class="grid two">
              <div>
                <label for="name">Full Name *</label>
                <input id="name" name="name" type="text" autocomplete="name" required />
              </div>
              <div>
                <label for="email">Email *</label>
                <input id="email" name="email" type="email" autocomplete="email" required />
              </div>
            </div>
            <div class="grid two" style="margin-top:14px;">
              <div>
                <label for="phone">Phone *</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" required />
              </div>
              <div>
                <label for="square_meters">Approx. Paintable Area (sq ft) *</label>
                <input id="square_meters" name="square_meters" type="number" min="10" step="1" required />
              </div>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">Location</div>
            <div class="grid three">
              <div>
                <label for="street">Street Address *</label>
                <input id="street" name="street" type="text" autocomplete="street-address" required />
              </div>
              <div>
                <label for="city">City *</label>
                <input id="city" name="city" type="text" autocomplete="address-level2" required />
              </div>
              <div>
                <label for="state">State *</label>
                <input id="state" name="state" type="text" maxlength="2" placeholder="CA" autocomplete="address-level1" required />
              </div>
            </div>
            <div class="grid two" style="margin-top:14px;">
              <div>
                <label for="zip">ZIP Code *</label>
                <input id="zip" name="zip" type="text" inputmode="numeric" autocomplete="postal-code" required />
              </div>
              <div>
                <label for="job_type">Job Type</label>
                <select id="job_type" name="job_type">
                  <option value="interior">Interior</option>
                  <option value="exterior">Exterior</option>
                  <option value="both">Both</option>
                </select>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">Scope details</div>
            <div>
              <label for="address">Project Notes / Location Details *</label>
              <textarea
                id="address"
                name="address"
                required
                placeholder="Example: Living room + hallway. Walls only. Existing paint in good condition. Please include minor patching."
              ></textarea>
              <div class="hint">Helpful: # rooms, ceiling height, trim/doors, prep &amp; repairs, access notes.</div>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">Photos</div>
            <div>
              <label>Upload Photos (1–5 images) *</label>

              <label class="uploadBox" id="uploadBox" for="files" style="display:block;">
                <input type="file" id="files" name="files" multiple accept="image/*" style="display:none" />
                <div class="uploadTop">
                  <div>
                    <div class="uploadTitle">Click to select photos</div>
                    <div class="uploadMeta">JPG/PNG/WebP • Up to 5 files</div>
                  </div>
                  <div class="pill">S3 presigned</div>
                </div>

                <div class="files" id="fileList"></div>
                <div class="status" id="uploadStatus">No files selected yet.</div>
                <div id="photoKeysContainer"></div>
              </label>
            </div>

            <div class="actions">
              <button type="submit" class="btn btnPrimary" id="submitBtn">Submit Request</button>
              <button type="button" class="btn btnGhost" id="resetBtn">Reset</button>
            </div>

            <div class="tiny">By submitting, you agree we may use your photos to generate an automated estimate.</div>
          </div>
        </form>
      </div>
    </div>

    <div class="card sideCard">
      <div class="header">
        <div class="title" style="font-size:18px;">Estimate summary</div>
        <div class="subtitle">We’ll price labor + materials and generate a shareable estimate link.</div>
      </div>
      <div class="content">
        <div class="sideTitle">What we need</div>
        <div class="sideList">
          <div class="sideItem"><b>Clear photos</b><span>Wide shots + close-ups of repairs or damage.</span></div>
          <div class="sideItem"><b>Approx. area (sq ft)</b><span>Estimate is fine — we refine from vision output.</span></div>
          <div class="sideItem"><b>Notes</b><span>Trim/doors? Ceilings? Prep level? Access issues?</span></div>
        </div>

        <div class="summary">
          <div class="kv"><span>Tenant</span><strong>{{ tenant_id or "painters_us" }}</strong></div>
          <div class="kv"><span>Units</span><strong>Square feet</strong></div>
          <div class="kv"><span>Photos</span><strong>1–5</strong></div>
        </div>

        <div class="sideTitle" style="margin-top:14px;">Example scope</div>
        <div class="sideItem">
          <span>“Interior walls only, 2 bedrooms + hallway, standard prep, include minor patching, 8 ft ceilings.”</span>
        </div>
      </div>
    </div>
  </div>

<script>
  const TENANT_ID = "{{ tenant_id or 'painters_us' }}";
  const VERTICAL_SLUG = "painters-us"; // /intake/painters-us/lead

  const MAX_FILES = 5;
  const MAX_BYTES = 15 * 1024 * 1024;
  const ALLOWED_TYPES = new Set(["image/jpeg", "image/png", "image/webp"]);

  const form = document.getElementById('intakeForm');
  const fileInput = document.getElementById('files');
  const fileList = document.getElementById('fileList');
  const uploadStatus = document.getElementById('uploadStatus');
  const photoKeysContainer = document.getElementById('photoKeysContainer');
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');
  const leadIdInput = document.getElementById('lead_id');

  const msgOk = document.getElementById('msgOk');
  const msgErr = document.getElementById('msgErr');

  let uploadInProgress = false;
  let leadId = null;

  function showOk(html){
    msgErr.style.display = 'none';
    msgOk.innerHTML = html;
    msgOk.style.display = 'block';
  }

  function showErr(text){
    msgOk.style.display = 'none';
    msgErr.textContent = text;
    msgErr.style.display = 'block';
  }

  function clearMsgs(){
    msgOk.style.display = 'none';
    msgErr.style.display = 'none';
  }

  function createHiddenPhotoKey(key){
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'photo_keys';
    input.value = key; // object_key (tenant/.../uploads/...)
    photoKeysContainer.appendChild(input);
  }

  function normalizeType(file){
    const t = (file.type || "image/jpeg").toLowerCase();
    return t === "image/jpg" ? "image/jpeg" : t;
  }

  function formatBytes(bytes){
    const mb = bytes / 1024 / 1024;
    return `${mb.toFixed(mb >= 10 ? 0 : 2)} MB`;
  }

  function createFileRow(file){
    const row = document.createElement('div');
    row.className = 'fileRow';
    row.innerHTML = `
      <div class="fileLeft">
        <div class="fileName" title="${file.name}">${file.name}</div>
        <small>${formatBytes(file.size)}</small>
      </div>
      <div class="fileMeta">
        <span class="tag up">Uploading…</span>
      </div>
    `;
    const tag = row.querySelector('.tag');
    return { row, tag };
  }

  async function createDraftLeadViaForm(){
    const name  = (form.querySelector('#name')?.value || '').trim();
    const email = (form.querySelector('#email')?.value || '').trim();
    const phone = (form.querySelector('#phone')?.value || '').trim();

    if(!name || !email || !phone){
      throw new Error("Fill contact fields (name/email/phone) before uploading photos.");
    }

    const fd = new FormData();
    fd.append("tenant_id", TENANT_ID);
    fd.append("vertical", "painters_us");
    fd.append("area_unit", "sqft");

    fd.append("name", name);
    fd.append("email", email);
    fd.append("phone", phone);

    const sqm = (form.querySelector('#square_meters')?.value || "").toString();
    if(sqm) fd.append("square_meters", sqm);

    const addressNotes = (form.querySelector('#address')?.value || '').trim();
    if(addressNotes) fd.append("address", addressNotes);

    const url = `/intake/${VERTICAL_SLUG}/lead?format=json`;
    const resp = await fetch(url, { method: "POST", body: fd });

    const data = await resp.json().catch(()=> ({}));
    if(!resp.ok){
      throw new Error(`create_lead_failed: ${JSON.stringify(data.detail ?? data)}`);
    }
    if(!data.lead_id){
      throw new Error("create_lead_failed: missing lead_id");
    }
    return data.lead_id;
  }

  async function ensureLeadId(){
    if(leadId) return leadId;

    uploadStatus.textContent = "Creating request…";
    leadId = await createDraftLeadViaForm();
    if(leadIdInput) leadIdInput.value = String(leadId);
    uploadStatus.textContent = `Request created (#${leadId}). Uploading photos…`;
    return leadId;
  }

  async function uploadFileToS3(file){
    const ctype = normalizeType(file);

    if(file.size <= 0 || file.size > MAX_BYTES){
      throw new Error("file_too_large");
    }
    if(!ALLOWED_TYPES.has(ctype)){
      throw new Error("unsupported_type");
    }

    const id = await ensureLeadId();

    // presign
    const res = await fetch('/uploads/presign', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer demo'
      },
      body: JSON.stringify({
        filename: file.name,
        content_type: ctype,
        size: file.size,
        lead_id: String(id)
      })
    });

    if(!res.ok){
      const t = await res.text();
      throw new Error("presign_failed: " + t);
    }

    const data = await res.json();

    // upload to S3
    const formData = new FormData();
    Object.entries(data.fields).forEach(([k,v]) => formData.append(k, v));
    formData.append('file', file);

    const s3Res = await fetch(data.url, { method:'POST', body: formData });
    if(!s3Res.ok){
      const txt = await s3Res.text().catch(()=> "");
      throw new Error("s3_upload_failed: " + txt);
    }

    // complete (create UploadRecord)
    const cRes = await fetch('/uploads/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        lead_id: Number(id),
        object_key: data.object_key
      })
    });
    if(!cRes.ok){
      const t = await cRes.text();
      throw new Error("complete_failed: " + t);
    }

    return data.object_key;
  }

  fileInput.addEventListener('change', async function(){
    clearMsgs();

    const files = Array.from(this.files || []);
    fileList.innerHTML = '';
    photoKeysContainer.innerHTML = '';

    if(files.length === 0){
      uploadStatus.textContent = 'No files selected yet.';
      return;
    }

    if(files.length > MAX_FILES){
      showErr(`Maximum ${MAX_FILES} files allowed.`);
      this.value = '';
      uploadStatus.textContent = 'Upload cancelled.';
      return;
    }

    for(const f of files){
      const ctype = normalizeType(f);
      if(!ALLOWED_TYPES.has(ctype)){
        showErr('Only JPG, PNG or WebP images are allowed.');
        this.value = '';
        uploadStatus.textContent = 'Upload cancelled.';
        return;
      }
      if(f.size <= 0 || f.size > MAX_BYTES){
        showErr(`Each file must be under ${Math.floor(MAX_BYTES/1024/1024)} MB.`);
        this.value = '';
        uploadStatus.textContent = 'Upload cancelled.';
        return;
      }
    }

    uploadInProgress = true;
    submitBtn.disabled = true;
    uploadStatus.textContent = `Uploading ${files.length} photo(s)…`;

    try{
      let uploaded = 0;

      for(const f of files){
        const { row, tag } = createFileRow(f);
        fileList.appendChild(row);

        const key = await uploadFileToS3(f);
        createHiddenPhotoKey(key);

        uploaded += 1;
        tag.textContent = 'Uploaded';
        tag.classList.remove('up');
        tag.classList.add('ok');

        uploadStatus.textContent = `✅ Uploaded ${uploaded}/${files.length} photo(s)`;
      }

      uploadStatus.textContent = `✅ Uploaded ${uploaded} photo(s)`;
    }catch(err){
      console.error(err);
      const msg = String(err?.message || err || '');

      if(msg.includes('Fill contact fields')){
        showErr('Please fill Name, Email and Phone before uploading photos.');
      }else if(msg.includes('file_too_large')){
        showErr(`One of the files is too large (max ${Math.floor(MAX_BYTES/1024/1024)} MB).`);
      }else if(msg.includes('unsupported_type')){
        showErr('Unsupported file type. Please use JPG, PNG, or WebP.');
      }else if(msg.includes('presign_failed')){
        showErr('Could not start upload (presign failed). Please try again.');
      }else if(msg.includes('complete_failed')){
        showErr('Upload succeeded but server did not register the file (complete failed).');
      }else{
        showErr('Photo upload failed. Please try again.');
      }

      this.value = '';
      fileList.innerHTML = '';
      photoKeysContainer.innerHTML = '';
      uploadStatus.textContent = '❌ Upload failed';
    }finally{
      uploadInProgress = false;
      submitBtn.disabled = false;
    }
  });

  resetBtn.addEventListener('click', () => {
    form.reset();
    fileInput.value = '';
    fileList.innerHTML = '';
    photoKeysContainer.innerHTML = '';
    uploadStatus.textContent = 'No files selected yet.';
    clearMsgs();

    leadId = null;
    if(leadIdInput) leadIdInput.value = '';
  });

  form.addEventListener('submit', async function(e){
    e.preventDefault();
    clearMsgs();

    if(uploadInProgress){
      showErr('Please wait until photo uploads finish.');
      return;
    }

    const photoKeyInputs = document.querySelectorAll('input[name="photo_keys"]');
    if(photoKeyInputs.length === 0){
      showErr('Please upload at least one photo.');
      return;
    }

    const area = parseFloat(form.querySelector('#square_meters').value);
    if(!area || area <= 0){
      showErr('Please enter an area greater than 0.');
      return;
    }

    const oldBtnText = submitBtn.textContent;

    try{
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting…';

      const id = await ensureLeadId();
      if(leadIdInput) leadIdInput.value = String(id);

      const street = (form.querySelector('#street')?.value || '').trim();
      const city = (form.querySelector('#city')?.value || '').trim();
      const state = (form.querySelector('#state')?.value || '').trim();
      const zip = (form.querySelector('#zip')?.value || '').trim();

      const notes = form.querySelector('#address');
      const oneLine = [street, city, state, zip].filter(Boolean).join(', ');
      if(oneLine && notes && !notes.value.includes(oneLine)){
        notes.value = `Address: ${oneLine}\n\n${notes.value || ''}`.trim();
      }

      const formData = new FormData(form);
      formData.set("lead_id", String(id));

      const res = await fetch('/intake/lead', { method:'POST', body: formData });

      if (res.redirected) { window.location.href = res.url; return; }

      const loc = res.headers.get('location');
      if ([301,302,303,307,308].includes(res.status) && loc) { window.location.href = loc; return; }

      const ct = (res.headers.get('content-type') || '').toLowerCase();
      const data = ct.includes('application/json') ? await res.json() : null;

      if(!res.ok){
        showErr(data?.detail ? JSON.stringify(data.detail) : 'Submission failed.');
        return;
      }

      if (data?.lead_id) {
        window.location.href = `/quotes/${data.lead_id}/status?autostart=1`;
        return;
      }

      if(leadId){
        window.location.href = `/quotes/${leadId}/status?autostart=1`;
        return;
      }

      showErr('Unexpected response from server.');
    }catch(err){
      console.error(err);
      showErr('Unexpected error submitting request.');
    }finally{
      submitBtn.disabled = false;
      submitBtn.textContent = oldBtnText || 'Submit Request';
    }
  });
</script>

</body>
</html>
