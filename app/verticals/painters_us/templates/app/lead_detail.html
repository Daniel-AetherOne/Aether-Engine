{% extends "app/layout.html" %}
{% block content %}

<div class="space-y-6">

  {% set sent = request.query_params.get('sent') %}
  {% set send_error = request.query_params.get('send_error') %}

  <!-- Toast (copy link feedback) -->
  <div id="toast"
       class="pointer-events-none fixed bottom-5 right-5 hidden max-w-sm rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-800 shadow-lg">
    <div class="font-semibold">Copied</div>
    <div class="text-xs text-slate-600">Link copied to clipboard.</div>
  </div>

  <!-- Top row: back + title + actions -->
  <div class="flex flex-wrap items-center justify-between gap-3">
    <a
      href="/app/leads"
      class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50"
    >
      ← Back to leads
    </a>

    <div class="flex flex-wrap items-center gap-2">
      {% if lead.public_token %}
        <a
          class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50"
          href="/e/{{ lead.public_token }}"
          target="_blank"
        >
          Open public estimate
        </a>

        <button
          class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50"
          type="button"
          onclick="copyText('{{ '/e/' ~ lead.public_token }}')"
          title="Copy public path"
        >
          Copy link
        </button>
      {% endif %}

      {% if lead.estimate_html_key %}
        <a
          class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800"
          href="/app/leads/{{ lead.id }}/estimate"
          target="_blank"
        >
          Open estimate
        </a>

        <form id="sendEstimateFormTop" method="post" action="/app/leads/{{ lead.id }}/send" class="m-0">
          <button
            id="sendEstimateBtnTop"
            class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50 disabled:cursor-not-allowed disabled:opacity-60"
            type="submit"
          >
            Send estimate
          </button>
        </form>
      {% endif %}
    </div>
  </div>

  <!-- Alerts -->
  {% if sent == '1' %}
    <div class="rounded-2xl border border-emerald-500/30 bg-emerald-50 px-4 py-3">
      <div class="font-semibold text-emerald-900">Estimate sent</div>
      <div class="mt-0.5 text-sm text-slate-700">The customer will receive the email shortly.</div>
    </div>
  {% endif %}

  {% if send_error == 'postmark_pending' %}
    <div class="rounded-2xl border border-rose-500/30 bg-rose-50 px-4 py-3">
      <div class="font-semibold text-rose-900">Email sending not active yet</div>
      <div class="mt-0.5 text-sm text-slate-700">
        Postmark is pending approval. While pending, you can only send to recipients on the same domain as your From address
        (<code class="rounded bg-white/60 px-1 py-0.5">getpaintly.com</code>).
      </div>
      <div class="mt-2 text-xs text-slate-600">
        Tip: for testing, use <code class="rounded bg-white/60 px-1 py-0.5">you@getpaintly.com</code>.
      </div>
    </div>
  {% endif %}

  {% if send_error and send_error not in ['postmark_pending'] %}
    <div class="rounded-2xl border border-rose-500/30 bg-rose-50 px-4 py-3">
      <div class="font-semibold text-rose-900">Could not send estimate</div>
      <div class="mt-0.5 text-sm text-slate-700">Please try again.</div>
    </div>
  {% endif %}

  <!-- Lead card -->
  <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <h2 class="text-xl font-semibold tracking-tight">Lead {{ lead.id }}</h2>

        {% set st = (lead.status or '').upper() %}
        {% if st in ['ACCEPTED','DONE','COMPLETED'] %}
          {% set badge_cls = 'bg-emerald-100 text-emerald-800 border-emerald-200' %}
        {% elif st in ['SENT','VIEWED'] %}
          {% set badge_cls = 'bg-amber-100 text-amber-800 border-amber-200' %}
        {% elif st in ['CANCELLED'] %}
          {% set badge_cls = 'bg-rose-100 text-rose-800 border-rose-200' %}
        {% else %}
          {% set badge_cls = 'bg-slate-100 text-slate-800 border-slate-200' %}
        {% endif %}

        <span class="inline-flex items-center rounded-full border px-2.5 py-1 text-xs font-semibold {{ badge_cls }}">
          {{ st or '—' }}
        </span>
      </div>

      {% if lead.estimate_html_key %}
        <div id="sendHint" class="hidden text-xs text-slate-600">
          Sending estimate…
        </div>
      {% endif %}
    </div>

    <div class="mt-4 grid gap-4 md:grid-cols-2">
      <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Customer</div>
        <div class="mt-1 text-sm font-semibold text-slate-900">{{ lead.customer_name or "—" }}</div>

        <div class="mt-3 text-xs font-semibold uppercase tracking-wide text-slate-500">Address</div>
        <div class="mt-1 text-sm text-slate-800">{{ lead.address or "—" }}</div>
      </div>

      <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Description</div>
        <div class="mt-1 text-sm text-slate-800">
          {{ lead.project_description or "—" }}
        </div>
      </div>
    </div>

    <div class="mt-4 rounded-xl border border-slate-200 bg-white p-4">
      <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Estimate HTML Key</div>
      <div class="mt-1 break-all text-sm text-slate-700">{{ lead.estimate_html_key or "—" }}</div>
    </div>

    {% if lead.public_token %}
      <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4">
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Public URL</div>

        <div class="mt-3 flex flex-wrap items-center gap-2">
          <a
            class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50"
            href="/e/{{ lead.public_token }}"
            target="_blank"
          >
            Open public estimate
          </a>

          <span class="rounded-lg bg-white px-3 py-2 text-xs text-slate-600 ring-1 ring-inset ring-slate-200">
            /e/{{ lead.public_token }}
          </span>

          <button
            class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50"
            type="button"
            onclick="copyText('{{ '/e/' ~ lead.public_token }}')"
          >
            Copy link
          </button>
        </div>

        <div class="mt-2 text-xs text-slate-500">
          Tip: This is the link customers can use to view and accept the estimate.
        </div>
      </div>
    {% endif %}

    {% if lead.needs_review_reasons %}
      <div class="mt-4 rounded-xl border border-slate-200 bg-white p-4">
        <div class="text-sm font-semibold text-slate-900">Needs review reasons</div>
        <pre class="mt-2 max-h-80 overflow-auto rounded-xl bg-slate-50 p-3 text-xs text-slate-700 ring-1 ring-inset ring-slate-200">{{ lead.needs_review_reasons }}</pre>
      </div>
    {% endif %}
  </div>

  <!-- Job card -->
  {% if job %}
    <div id="job" class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <div class="text-sm font-semibold text-slate-900">Job</div>
          <div class="mt-1 text-sm text-slate-700">
            Job ID: <span class="font-semibold text-slate-900">{{ job.id }}</span>
          </div>
        </div>

        {% set jst = (job.status or '').upper() %}
        {% if jst in ['DONE'] %}
          {% set jbadge = 'bg-emerald-100 text-emerald-800 border-emerald-200' %}
        {% elif jst in ['IN_PROGRESS'] %}
          {% set jbadge = 'bg-indigo-100 text-indigo-800 border-indigo-200' %}
        {% elif jst in ['SCHEDULED'] %}
          {% set jbadge = 'bg-sky-100 text-sky-800 border-sky-200' %}
        {% elif jst in ['CANCELLED'] %}
          {% set jbadge = 'bg-rose-100 text-rose-800 border-rose-200' %}
        {% else %}
          {% set jbadge = 'bg-slate-100 text-slate-800 border-slate-200' %}
        {% endif %}

        <div class="inline-flex items-center rounded-full border px-2.5 py-1 text-xs font-semibold {{ jbadge }}">
          {{ jst or '—' }}
        </div>
      </div>

      <!-- Timeline -->
      <div class="rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
        <div class="grid gap-1">
          <div>
            <span class="font-semibold text-slate-900">Scheduled:</span>
            {% if job.scheduled_at %}
              {{ scheduled_display }} <span class="text-xs text-slate-500">({{ tz_name }})</span>
            {% else %}
              —
            {% endif %}
          </div>

          {% if job.started_at %}
            <div>
              <span class="font-semibold text-slate-900">Started:</span>
              {{ started_display }} <span class="text-xs text-slate-500">({{ tz_name }})</span>
            </div>
          {% endif %}

          {% if job.done_at %}
            <div>
              <span class="font-semibold text-slate-900">Done:</span>
              {{ done_display }} <span class="text-xs text-slate-500">({{ tz_name }})</span>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Hidden unschedule form -->
      <form id="unscheduleForm" method="post" action="/app/jobs/{{ job.id }}/unschedule" class="hidden"></form>

      {% if job.scheduled_at and job.status not in ["CANCELLED"] %}
        <div>
          <button
            class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50"
            type="button"
            onclick="document.getElementById('unscheduleForm').submit();"
          >
            Unschedule
          </button>
        </div>
      {% endif %}

      <!-- Scheduling UX Upgrade -->
      {% if job.status in ["NEW","SCHEDULED"] %}
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 space-y-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-sm font-semibold text-slate-900">Scheduling</div>
              <div class="mt-1 text-xs text-slate-600">Timezone: {{ tz_name }}</div>
            </div>

            {% if job.scheduled_at %}
              <div class="text-right">
                <div class="text-sm font-semibold text-slate-900">{{ scheduled_display }}</div>
                <div class="text-xs text-slate-600">Currently scheduled</div>
              </div>
            {% endif %}
          </div>

          <form id="scheduleForm" method="post" action="/app/jobs/{{ job.id }}/schedule" class="space-y-3">
            <div class="flex flex-wrap items-center gap-2">
              <input
                id="dtInput"
                type="datetime-local"
                name="scheduled_at_local"
                value="{{ scheduled_input_value }}"
                required
                class="h-10 rounded-xl border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/10"
              />

              <button
                class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800"
                type="submit"
              >
                {% if job.scheduled_at %}Update{% else %}Schedule{% endif %}
              </button>

              {% if job.scheduled_at %}
                <button
                  class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50"
                  type="button"
                  onclick="document.getElementById('unscheduleForm').submit();"
                >
                  Clear
                </button>
              {% endif %}
            </div>

            <div class="flex flex-wrap gap-2">
              <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="setDayOffset(0)">Today</button>
              <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="setDayOffset(1)">Tomorrow</button>
              <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="setDayOffset(2)">+2 days</button>
            </div>

            <div>
              <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Quick times</div>
              <div class="mt-2 flex flex-wrap gap-2">
                <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="setTime('09:00')">9:00</button>
                <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="setTime('11:00')">11:00</button>
                <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="setTime('13:00')">1:00 PM</button>
                <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="setTime('15:00')">3:00 PM</button>
              </div>
            </div>

            <div>
              <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">One-click schedule</div>
              <div class="mt-2 flex flex-wrap gap-2">
                <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="quickSchedule(0,'09:00')">Today 9</button>
                <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="quickSchedule(0,'13:00')">Today 1</button>
                <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="quickSchedule(1,'09:00')">Tomorrow 9</button>
                <button type="button" class="inline-flex items-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" onclick="quickSchedule(1,'13:00')">Tomorrow 1</button>
              </div>
            </div>
          </form>

          <script>
            function pad(n){ return String(n).padStart(2,'0'); }
            function setDayOffset(offsetDays){
              const input = document.getElementById("dtInput");
              if(!input) return;
              const current = input.value ? new Date(input.value) : new Date();
              const d = new Date(current.getTime());
              d.setDate(d.getDate() + offsetDays);
              const yyyy = d.getFullYear();
              const mm = pad(d.getMonth()+1);
              const dd = pad(d.getDate());
              let time = "09:00";
              if (input.value && input.value.includes("T")) {
                const t = input.value.split("T")[1];
                time = (t && t.length >= 5) ? t.slice(0,5) : "09:00";
              }
              input.value = `${yyyy}-${mm}-${dd}T${time}`;
            }
            function setTime(hhmm){
              const input = document.getElementById("dtInput");
              if(!input) return;
              if(!input.value){
                const d = new Date();
                const yyyy = d.getFullYear();
                const mm = pad(d.getMonth()+1);
                const dd = pad(d.getDate());
                input.value = `${yyyy}-${mm}-${dd}T${hhmm}`;
                return;
              }
              const parts = input.value.split("T");
              const datePart = parts[0];
              input.value = `${datePart}T${hhmm}`;
            }
            function quickSchedule(dayOffset, hhmm){
              setDayOffset(dayOffset);
              setTime(hhmm);
              document.getElementById("scheduleForm").submit();
            }
          </script>
        </div>
      {% endif %}

      <!-- Action buttons -->
      <div class="flex flex-wrap items-center gap-2">
        {% if job.status == "SCHEDULED" %}
          <form method="post" action="/app/jobs/{{ job.id }}/start" class="m-0">
            <button class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800" type="submit">
              Start
            </button>
          </form>
        {% endif %}

        {% if job.status == "IN_PROGRESS" %}
          <form method="post" action="/app/jobs/{{ job.id }}/done" class="m-0">
            <button class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800" type="submit">
              Mark done
            </button>
          </form>
        {% endif %}

        <form method="post" action="/app/jobs/{{ job.id }}/status" class="flex flex-wrap items-center gap-2 m-0">
          <select
            name="status"
            class="h-10 rounded-xl border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-900/10"
          >
            {% for s in ["NEW","SCHEDULED","IN_PROGRESS","DONE","CANCELLED"] %}
              <option value="{{ s }}" {% if job.status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>

          <button class="inline-flex items-center rounded-xl bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-200 hover:bg-slate-50" type="submit">
            Update
          </button>
        </form>
      </div>
    </div>
  {% endif %}

</div>

<script>
  // Copy helper + toast
  function copyText(text) {
    const toast = document.getElementById("toast");
    const showToast = () => {
      if (!toast) return;
      toast.classList.remove("hidden");
      toast.classList.add("block");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        toast.classList.add("hidden");
        toast.classList.remove("block");
      }, 1600);
    };

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(showToast).catch(() => {
        prompt("Copy this:", text);
      });
    } else {
      prompt("Copy this:", text);
    }
  }

  // Sending state hint (top send form)
  (function(){
    const form = document.getElementById('sendEstimateFormTop');
    const btn  = document.getElementById('sendEstimateBtnTop');
    const hint = document.getElementById('sendHint');
    if(!form || !btn) return;

    form.addEventListener('submit', () => {
      btn.disabled = true;
      btn.textContent = 'Sending…';
      if (hint) hint.classList.remove('hidden');
    });
  })();
</script>

{% if job and job.status not in ["DONE","CANCELLED"] %}
<script>
  setInterval(() => window.location.reload(), 4000);
</script>
{% endif %}

{% endblock %}
