{% extends "app/layout.html" %}
{% block content %}

<div class="space-y-6">

  <!-- Header -->
  <div class="flex flex-wrap items-start justify-between gap-4">
    <div class="space-y-1">
      <div class="flex items-center gap-3">
        <a class="inline-flex h-9 items-center justify-center rounded-lg border border-slate-200 bg-white px-3 text-sm font-medium text-slate-900 shadow-sm hover:bg-slate-50 transition-colors"
           href="/app/reviews">
          ← Review queue
        </a>

        <span class="inline-flex items-center rounded-full bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-700 ring-1 ring-inset ring-amber-200">
          NEEDS_REVIEW
        </span>

        <span class="text-sm text-slate-500">Lead #{{ lead.id }}</span>
      </div>

      <h1 class="text-2xl font-semibold tracking-tight text-slate-900">
        {{ lead.customer_name or lead.name or "Lead review" }}
      </h1>

      <div class="text-sm text-slate-600">
        {% if lead.customer_email or lead.email %}
          <span>{{ lead.customer_email or lead.email }}</span>
        {% endif %}
        {% if (lead.customer_phone or lead.phone) and (lead.customer_email or lead.email) %}
          <span class="text-slate-300">•</span>
        {% endif %}
        {% if lead.customer_phone or lead.phone %}
          <span>{{ lead.customer_phone or lead.phone }}</span>
        {% endif %}
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      {% if estimate_preview_url %}
  <a class="w-full inline-flex h-10 items-center justify-center rounded-lg border border-slate-200 bg-white px-4 text-sm font-medium text-slate-900 shadow-sm hover:bg-slate-50 transition-colors"
     href="{{ estimate_preview_url }}" target="_blank">
    Preview estimate
  </a>
{% endif %}

      <form method="post" action="/app/reviews/{{ lead.id }}/generate-estimate">
        <button type="submit"
                class="inline-flex h-9 items-center justify-center rounded-lg bg-slate-900 px-4 text-sm font-medium text-white shadow-sm hover:bg-slate-800 transition-colors">
          Generate estimate
        </button>
      </form>
    </div>
  </div>

  <!-- Top grid -->
  <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">

    <!-- Left: Customer + Project -->
    <div class="lg:col-span-2 space-y-6">

      <!-- Project -->
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <h2 class="text-base font-semibold text-slate-900">Project</h2>

  <dl class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
    <div>
      <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Job type</dt>
      <dd class="mt-1 text-sm text-slate-900">{{ lead.job_type or "—" }}</dd>
    </div>

    <div>
      <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Timezone</dt>
      <dd class="mt-1 text-sm text-slate-900">{{ lead.timezone or "—" }}</dd>
    </div>

    <div class="sm:col-span-2">
      <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Notes</dt>
      <dd class="mt-1 text-sm text-slate-900 whitespace-pre-wrap">
        {{ ((lead.project_notes or lead.notes or "").split("VISION_JSON=")[0] | trim) or "—" }}
      </dd>
    </div>
  </dl>
</div>

      <!-- Review reasons -->
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-base font-semibold text-slate-900">Why it needs review</h2>

        {% if reasons and reasons|length > 0 %}
          <ul class="mt-4 space-y-2">
            {% for r in reasons %}
              <li class="flex gap-2 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
                <span class="mt-0.5 inline-flex h-5 w-5 items-center justify-center rounded-full bg-amber-200/70 text-amber-900 text-xs font-bold">!</span>
                <span class="flex-1">{{ r }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="mt-3 text-sm text-slate-600">
            No reasons found (meta missing). You can still generate an estimate manually.
          </div>
        {% endif %}
      </div>

      <!-- Photos -->
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-semibold text-slate-900">Photos</h2>
          <div class="text-sm text-slate-500">{{ (photo_urls|length) if photo_urls else 0 }} files</div>
        </div>

        {% if photo_urls and photo_urls|length > 0 %}
          <div class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-4">
            {% for url in photo_urls %}
              <a href="{{ url }}" target="_blank"
                 class="group relative overflow-hidden rounded-xl border border-slate-200 bg-slate-50">
                <img src="{{ url }}" alt="Photo"
                     class="h-32 w-full object-cover transition-transform duration-200 group-hover:scale-[1.02]" />
                <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/50 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <div class="text-xs font-medium text-white">Open</div>
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="mt-3 text-sm text-slate-600">No photos found for this lead.</div>
        {% endif %}
      </div>
    </div>

    <!-- Right: Quick info -->
    <div class="space-y-6">

      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-base font-semibold text-slate-900">Customer</h2>

        <dl class="mt-4 space-y-3">
          <div>
            <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Name</dt>
            <dd class="mt-1 text-sm text-slate-900">{{ lead.customer_name or lead.name or "—" }}</dd>
          </div>
          <div>
            <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Email</dt>
            <dd class="mt-1 text-sm text-slate-900">{{ lead.customer_email or lead.email or "—" }}</dd>
          </div>
          <div>
            <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Phone</dt>
            <dd class="mt-1 text-sm text-slate-900">{{ lead.customer_phone or lead.phone or "—" }}</dd>
          </div>
          <div>
            <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">Address</dt>
            <dd class="mt-1 text-sm text-slate-900 whitespace-pre-wrap">
              {{ lead.address or lead.customer_address or "—" }}
            </dd>
          </div>
        </dl>
      </div>
	  
	  <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <h2 class="text-base font-semibold text-slate-900">Adjust estimate inputs</h2>
  <p class="mt-2 text-sm text-slate-600">These values will be used when generating the estimate.</p>

  <form class="mt-4 space-y-4" method="post" action="/app/reviews/{{ lead.id }}/overrides">
    <div>
      <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">Approx. area (sq ft)</label>
      <input name="square_feet" type="number" min="10" step="1"
             value="{% if intake.get('square_meters') %}{{ (intake.get('square_meters') / 0.092903) | round(0) }}{% endif %}"
             class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm" />
    </div>

    <div>
      <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">Job type</label>
      <select name="job_type" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
        <option value="">—</option>
        <option value="interior" {% if intake.get('job_type') == 'interior' %}selected{% endif %}>Interior</option>
        <option value="exterior" {% if intake.get('job_type') == 'exterior' %}selected{% endif %}>Exterior</option>
        <option value="both" {% if intake.get('job_type') == 'both' %}selected{% endif %}>Both</option>
      </select>
    </div>

    <div>
      <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">Project notes</label>
      <textarea name="project_description" rows="4"
                class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">{{ intake.get('project_description') or '' }}</textarea>
    </div>

    <button type="submit"
            class="inline-flex h-9 items-center justify-center rounded-lg border border-slate-200 bg-white px-4 text-sm font-medium text-slate-900 shadow-sm hover:bg-slate-50">
      Save changes
    </button>
  </form>
</div>


      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-base font-semibold text-slate-900">Next step</h2>
        <p class="mt-2 text-sm text-slate-600">
          Click <span class="font-medium text-slate-900">Generate estimate</span> to restart the pipeline.
          When it’s ready, you’ll see a preview button here.
        </p>

        <div class="mt-4 space-y-2">
          <form method="post" action="/app/reviews/{{ lead.id }}/generate-estimate">
            <button type="submit"
                    class="w-full inline-flex h-10 items-center justify-center rounded-lg bg-slate-900 px-4 text-sm font-medium text-white shadow-sm hover:bg-slate-800 transition-colors">
              Generate estimate
            </button>
          </form>

          {% if can_preview %}
  <a class="w-full inline-flex h-10 items-center justify-center rounded-lg border border-slate-200 bg-white px-4 text-sm font-medium text-slate-900 shadow-sm hover:bg-slate-50 transition-colors"
     href="/app/leads/{{ lead.id }}/estimate?v={{ lead.updated_at }}" target="_blank">
    Preview estimate
  </a>
{% endif %}
        </div>
      </div>

      {% if estimate_preview_url %}
      <!-- Optional direct S3 presigned preview -->
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-base font-semibold text-slate-900">Direct preview link</h2>
        <a class="mt-3 inline-flex items-center text-sm font-medium text-slate-900 underline decoration-slate-300 underline-offset-4 hover:decoration-slate-500"
           href="{{ estimate_preview_url }}" target="_blank">
          Open rendered HTML (S3)
        </a>
      </div>
      {% endif %}

    </div>
  </div>
</div>

{% endblock %}
