<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Project Intake</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 720px; margin: 32px auto; }
    h1 { font-size: 28px; margin-bottom: 16px; }
    input, textarea, button { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
    textarea { min-height: 80px; }
    #fileList { list-style: none; padding-left: 0; }
    #fileList li { margin: 4px 0; }
    #status { margin-top: 12px; font-weight: 600; }
  </style>
</head>
<body>
  <h1>Project Intake</h1>

  <form id="intakeForm">
    <input id="name" name="name" placeholder="Naam" required />
    <input id="email" name="email" type="email" placeholder="E-mail" required />
    <input id="phone" name="phone" placeholder="Telefoon" />
    <textarea id="project_description" name="project_description" placeholder="Beschrijving"></textarea>

    <input id="fileInput" type="file" multiple accept=".jpg,.jpeg,.png,.pdf" />
    <ul id="fileList"></ul>

    <button type="submit">Verstuur</button>
  </form>

  <div id="status"></div>

  <script>
  const fileInput = document.getElementById('fileInput');
  const fileList  = document.getElementById('fileList');
  const form      = document.getElementById('intakeForm');
  const statusBox = document.getElementById('status');

  const uploadedKeys = new Set();
  let leadId = null; // Optie A: eerst lead aanmaken, dan uploaden

  async function createDraftLead() {
    // Maak een minimale lead aan zodat we lead_id hebben voor uploads/presign.
    // Backend moet dit accepteren en lead_id teruggeven.
    const payload = {
      name: document.getElementById('name').value || "Draft",
      email: document.getElementById('email').value || "draft@example.com",
      phone: document.getElementById('phone').value || "",
      project_description: document.getElementById('project_description').value || "",
      object_keys: [], // nog leeg, komt later
      draft: true
    };

    const resp = await fetch('/intake/lead', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      throw new Error(`create lead ${resp.status}: ${JSON.stringify(data.detail ?? data)}`);
    }
    return data.lead_id;
  }

  async function ensureLeadId() {
    if (leadId) return leadId;

    // Zorg dat naam/email ingevuld zijn (minimaal).
    // (Je kan dit later relaxen door backend draft-lead zonder email toe te staan.)
    const email = document.getElementById('email').value;
    const name = document.getElementById('name').value;
    if (!email || !name) {
      throw new Error("Vul eerst naam + email in (nodig om lead aan te maken).");
    }

    statusBox.textContent = "Lead aanmaken voor upload…";
    statusBox.style.color = "inherit";

    leadId = await createDraftLead();
    statusBox.textContent = `Lead draft aangemaakt (#${leadId}). Uploaden kan nu.`;
    return leadId;
  }

  async function presign(file) {
    const id = await ensureLeadId();

    const resp = await fetch('/uploads/presign', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        filename: file.name,
        content_type: file.type || undefined,
        size: file.size,
        lead_id: String(id),
      })
    });

    const txt = await resp.text();
    if (!resp.ok) throw new Error(`presign ${resp.status}: ${txt}`);
    return JSON.parse(txt);
  }

  async function uploadOne(file) {
    const { key, post } = await presign(file);

    const fd = new FormData();
    Object.entries(post.fields).forEach(([k,v]) => fd.append(k, v));
    fd.append('file', file);

    const res = await fetch(post.url, { method: 'POST', body: fd });
    const body = await res.text();
    if (!res.ok) throw new Error(`upload ${res.status}: ${body}`);

    return key; // tenant-loze key voor finalize
  }

  fileInput.addEventListener('change', async (e) => {
    fileList.innerHTML = '';
    uploadedKeys.clear();

    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;

    for (const f of files) {
      const li = document.createElement('li');
      li.textContent = `${f.name} — uploaden...`;
      fileList.appendChild(li);

      try {
        const key = await uploadOne(f);
        uploadedKeys.add(key);
        li.textContent = `${f.name} — ✅ klaar`;
      } catch (err) {
        console.error(err);
        li.textContent = `${f.name} — ❌ fout (${err.message})`;
      }
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!leadId) {
      statusBox.textContent = 'Maak eerst een lead aan (vul naam + email, upload daarna).';
      statusBox.style.color = 'crimson';
      return;
    }
    if (uploadedKeys.size === 0) {
      statusBox.textContent = 'Upload eerst minstens één bestand.';
      statusBox.style.color = 'crimson';
      return;
    }

    statusBox.textContent = 'Finaliseren...';
    statusBox.style.color = 'inherit';

    const payload = {
      lead_id: leadId,
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      project_description: document.getElementById('project_description').value,
      object_keys: Array.from(uploadedKeys),
      draft: false
    };

    // Backend: maak /intake/lead zo dat hij update doet als lead_id is meegegeven.
    const resp = await fetch('/intake/lead', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      statusBox.textContent = `Fout: ${JSON.stringify(data.detail ?? data)}`;
      statusBox.style.color = 'crimson';
      return;
    }

    statusBox.textContent = `✅ Lead gefinalized (#${data.lead_id}) met ${data.files?.length ?? uploadedKeys.size} bestanden.`;
    form.reset();
    fileList.innerHTML = '';
    uploadedKeys.clear();
    leadId = null;
  });
</script>
</body>
</html>
